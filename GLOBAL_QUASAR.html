<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>QUASARCHAT V1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;800&display=swap');
        :root { --main: #4f46e5; --bg: #0f172a; --text: #ffffff; }
        body.light-mode { --bg: #f8fafc; --text: #0f172a; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Plus_Jakarta_Sans', sans-serif; overflow: hidden; height: 100dvh; }
        
        .tab-content { display: none; height: calc(100dvh - 160px); overflow-y: auto; scroll-behavior: smooth; }
        .tab-content.active { display: block; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* STORY - FULL SCREEN NO SCROLLBAR */
        #view-story { height: calc(100dvh - 80px); padding: 0; overflow-y: scroll; scroll-snap-type: y mandatory; -ms-overflow-style: none; scrollbar-width: none; }
        #view-story::-webkit-scrollbar { display: none; }
        .anlik-card { height: calc(100dvh - 80px); width: 100%; position: relative; scroll-snap-align: start; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        .post-card { background: rgba(128,128,128,0.1); border-radius: 1.5rem; padding: 1.25rem; margin-bottom: 1rem; border: 1px solid rgba(128,128,128,0.05); }
        .nav-btn { font-size: 24px; opacity: 0.3; transition: 0.3s; }
        .nav-btn.active { opacity: 1; color: var(--main); transform: scale(1.1); }
        
        #gifPanel { max-height: 0; overflow: hidden; transition: 0.4s ease; background: var(--bg); }
        #gifPanel.active { max-height: 320px; border-top: 1px solid rgba(128,128,128,0.1); }
        #secretGuard { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
    </style>
</head>
<body class="dark-mode">

    <div id="secretGuard">
        <div class="w-72 p-8 bg-slate-900 rounded-[2.5rem] text-center border border-white/10 shadow-2xl">
            <h3 class="font-black text-[10px] text-indigo-500 mb-6 tracking-widest uppercase">EKSELANS Gƒ∞Rƒ∞≈ûƒ∞</h3>
            <input type="password" id="guardKey" placeholder="Global Key..." class="w-full p-4 bg-white/5 rounded-2xl text-white mb-4 outline-none text-center border border-white/5">
            <button id="authBtn" class="w-full bg-indigo-600 p-4 rounded-2xl font-black text-xs text-white">Sƒ∞STEMƒ∞ A√á</button>
        </div>
    </div>

    <div class="flex flex-col h-full max-w-md mx-auto relative">
        <header class="p-5 flex justify-between items-center border-b border-white/5 shrink-0">
            <h1 id="brandTrigger" class="font-black text-xl tracking-tighter text-indigo-500 select-none">QUASARCHAT V1.0</h1>
            <div class="text-[10px] font-bold opacity-40 bg-white/5 px-3 py-1 rounded-full">ID: <span id="myPublicId"></span></div>
        </header>

        <main class="flex-1 overflow-hidden relative">
            <div id="view-chat" class="tab-content active p-4 no-scrollbar">
                <div id="matchScreen" class="h-full flex flex-col items-center justify-center text-center">
                    <div id="matchInitial">
                        <div class="w-20 h-20 bg-indigo-500/10 rounded-full flex items-center justify-center text-4xl mb-6 mx-auto animate-pulse">üåç</div>
                        <button id="findBtn" class="bg-indigo-600 px-12 py-4 rounded-full font-black text-sm shadow-2xl uppercase tracking-widest active:scale-95 transition">FIND CHAT</button>
                    </div>
                    <div id="searchAnim" class="hidden flex flex-col items-center gap-4">
                        <div class="text-5xl animate-bounce">üîç</div>
                        <p class="text-[10px] font-black uppercase tracking-[0.3em] opacity-50">E≈üle≈üme Aranƒ±yor...</p>
                    </div>
                </div>
                <div id="msgCont" class="hidden flex flex-col gap-4 pb-10"></div>
            </div>

            <div id="view-story" class="tab-content no-scrollbar">
                <div id="storyCont"></div>
                <label class="fixed bottom-24 right-6 w-14 h-14 bg-indigo-600 rounded-full flex items-center justify-center text-2xl z-50 cursor-pointer shadow-2xl border-2 border-white/20 active:scale-90 transition">+ <input type="file" id="upStory" class="hidden" accept="image/*,video/*"></label>
            </div>

            <div id="view-posts" class="tab-content p-5 no-scrollbar">
                <div class="post-card mb-6">
                    <textarea id="postTxt" placeholder="D√ºnyaya bir not bƒ±rak..." class="w-full bg-transparent outline-none h-20 resize-none text-sm"></textarea>
                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-white/5">
                        <input type="file" id="upPost" class="hidden" accept="image/*,video/*">
                        <button onclick="document.getElementById('upPost').click()" class="text-2xl hover:opacity-70">üñºÔ∏è</button>
                        <button id="shareBtn" class="bg-indigo-600 px-8 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest">PAYLA≈û</button>
                    </div>
                </div>
                <div id="postCont" class="pb-10"></div>
            </div>

            <div id="view-settings" class="tab-content p-8 no-scrollbar">
                <h2 class="font-black text-3xl mb-10 italic tracking-tighter">Ayarlar</h2>
                <div class="space-y-6">
                    <div class="p-5 bg-white/5 rounded-[2rem] border border-white/5">
                        <p class="text-[10px] font-black mb-3 uppercase opacity-40">Konu≈ütuƒüum Dil</p>
                        <select id="myLang" class="w-full bg-transparent font-bold outline-none text-sm">
                            <option value="tr">T√ºrk√ße</option><option value="en">English</option>
                            <option value="ar">Arap√ßa</option><option value="it">ƒ∞talyanca</option>
                            <option value="de">Almanca</option><option value="ru">Rus√ßa</option>
                        </select>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="setTheme('light')" class="flex-1 p-4 bg-white text-black rounded-2xl font-black text-[10px] uppercase">G√úND√úZ</button>
                        <button onclick="setTheme('dark')" class="flex-1 p-4 bg-slate-800 text-white rounded-2xl font-black text-[10px] uppercase border border-white/10">GECE</button>
                    </div>
                    <div class="pt-10 border-t border-white/5">
                        <button id="adminBtn" class="w-full p-5 bg-white/5 rounded-2xl text-[10px] opacity-20 font-black uppercase tracking-widest">YETKƒ∞ DURUMU: YOK</button>
                    </div>
                </div>
            </div>
        </main>

        <div id="chatControls" class="hidden flex-col bg-inherit border-t border-white/5 shrink-0">
            <div id="gifPanel">
                <input type="text" id="gifInp" placeholder="GIF Ara..." class="w-full p-4 bg-white/5 outline-none text-xs border-b border-white/5">
                <div id="gifRes" class="grid grid-cols-3 gap-1 p-1 h-60 overflow-y-auto no-scrollbar"></div>
            </div>
            <div class="p-4 flex gap-3 items-center">
                <button id="gifBtn" class="w-12 h-12 bg-white/5 rounded-2xl text-[10px] font-black border border-white/5">GIF</button>
                <input type="text" id="chatInp" placeholder="Bir fƒ±sƒ±ltƒ± g√∂nder..." class="flex-1 bg-white/5 rounded-2xl px-5 py-4 text-sm outline-none border border-white/5">
                <button id="sendBtn" class="w-12 h-12 bg-indigo-600 rounded-2xl font-black text-white shadow-lg">></button>
            </div>
        </div>

        <nav class="h-20 border-t border-white/5 flex justify-around items-center shrink-0">
            <button onclick="go('chat')" id="n-chat" class="nav-btn active">üõ∞Ô∏è</button>
            <button onclick="go('story')" id="n-story" class="nav-btn">üåå</button>
            <button onclick="go('posts')" id="n-posts" class="nav-btn">‚òÑÔ∏è</button>
            <button onclick="go('settings')" id="n-settings" class="nav-btn">‚öôÔ∏è</button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, serverTimestamp, onDisconnect, off, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const conf = { apiKey: "AIzaSyD95hdJcssjRg9ClpFoG5HEKBrQYvica3U", databaseURL: "https://maskchat-2a2f8-default-rtdb.europe-west1.firebasedatabase.app" };
        const app = initializeApp(conf); const db = getDatabase(app);
        
        let myId = "u" + Math.random().toString(36).substr(2, 5);
        let myPub = Math.floor(1000 + Math.random() * 9000);
        let rid = null; 
        const isAdmin = localStorage.getItem('maskAdmin') === 'true';
        document.getElementById('myPublicId').innerText = myPub;

        // GLOBAL Sƒ∞LME FONKSƒ∞YONU (ADMƒ∞N √ñZEL)
        window.killElement = (path) => {
            if(isAdmin && confirm("Ekselanslarƒ±, bu veri sonsuza dek yok edilecek. Onaylƒ±yor musunuz?")) {
                remove(ref(db, path)).then(() => console.log("Yok edildi.")).catch(e => alert("Hata!"));
            }
        };

        // TRANSLATE MOTORU
        async function trl(t, f, to) {
            if(f === to) return t;
            try {
                const r = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${f}&tl=${to}&dt=t&q=${encodeURIComponent(t)}`);
                const d = await r.json(); return d[0][0][0];
            } catch(e) { return t; }
        }

        // NAVƒ∞GASYON
        window.go = (t) => {
            document.querySelectorAll('.tab-content, .nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('view-'+t).classList.add('active');
            document.getElementById('n-'+t).classList.add('active');
            document.getElementById('chatControls').classList.toggle('hidden', t !== 'chat' || !rid);
            if(t === 'story') loadStory(); if(t === 'posts') loadPost();
        };

        // MATCHING ENGINE
        document.getElementById('findBtn').onclick = () => {
            document.getElementById('matchInitial').classList.add('hidden');
            document.getElementById('searchAnim').classList.remove('hidden');
            const lRef = ref(db, 'lobby/' + myId);
            set(lRef, { s: 'wait', t: serverTimestamp() });
            onDisconnect(lRef).remove();

            onValue(ref(db, 'lobby'), (snap) => {
                const lobby = snap.val(); if(!lobby) return;
                const other = Object.keys(lobby).find(id => id !== myId && lobby[id].s === 'wait');
                if(other) {
                    off(ref(db, 'lobby')); remove(lRef);
                    rid = myId < other ? `${myId}_${other}` : `${other}_${myId}`;
                    startChat(rid);
                }
            });
        };

        function startChat(id) {
            set(ref(db, `rooms/${id}/config/${myId}`), { lang: document.getElementById('myLang').value });
            document.getElementById('matchScreen').classList.add('hidden');
            document.getElementById('msgCont').classList.remove('hidden');
            document.getElementById('chatControls').classList.remove('hidden');
            onValue(ref(db, `rooms/${id}`), snap => {
                const mDiv = document.getElementById('msgCont'); mDiv.innerHTML = "";
                if(!snap.exists()) return;
                Object.entries(snap.val()).forEach(([k, m]) => {
                    if(k === 'config') return;
                    const isMe = m.s === myId;
                    const html = m.type === 'gif' ? `<img src="${m.t}" class="w-48 rounded-2xl shadow-xl">` : `<div class="${isMe?'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20':'bg-white/5'} p-4 rounded-2xl text-sm max-w-[85%] border border-white/5">${m.orig ? '<small class="opacity-30 block text-[9px] mb-1">ORJ: '+m.orig+'</small>':''}${m.t}</div>`;
                    mDiv.innerHTML += `<div class="flex items-start gap-2 ${isMe?'justify-end':'justify-start'}">${isAdmin?`<button onclick="killElement('rooms/${rid}/${k}')" class="text-[10px] text-red-500 font-bold opacity-30 hover:opacity-100">√ó</button>`:''}${html}</div>`;
                });
                document.getElementById('view-chat').scrollTop = document.getElementById('view-chat').scrollHeight;
            });
        }

        document.getElementById('sendBtn').onclick = async () => {
            const inp = document.getElementById('chatInp'); const txt = inp.value.trim();
            if(!txt || !rid) return;
            const myL = document.getElementById('myLang').value;
            const cSnap = await get(ref(db, `rooms/${rid}/config`));
            const cfg = cSnap.val();
            const other = rid.replace(myId,"").replace("_","");
            const toL = (cfg && cfg[other]) ? cfg[other].lang : 'en';
            const res = await trl(txt, myL, toL);
            push(ref(db, `rooms/${rid}`), { s: myId, t: res, orig: (myL !== toL ? txt : null) });
            inp.value = "";
        };

        // GIF MOTORU
        document.getElementById('gifBtn').onclick = () => { document.getElementById('gifPanel').classList.toggle('active'); searchGif(); };
        document.getElementById('gifInp').oninput = () => searchGif();
        async function searchGif() {
            const q = document.getElementById('gifInp').value || 'trending';
            const r = await fetch(`https://g.tenor.com/v1/search?q=${q}&key=LIVDSRZULELA&limit=15`);
            const d = await r.json();
            const res = document.getElementById('gifRes'); res.innerHTML = "";
            d.results.forEach(g => {
                const img = document.createElement('img'); img.src = g.media[0].tinygif.url;
                img.className = "w-full h-24 object-cover rounded-xl cursor-pointer hover:scale-95 transition";
                img.onclick = () => { push(ref(db, `rooms/${rid}`), { s: myId, t: g.media[0].tinygif.url, type: 'gif' }); document.getElementById('gifPanel').classList.remove('active'); };
                res.appendChild(img);
            });
        }

        // DOSYA OKUYUCU
        const readFile = (file, cb) => { const r = new FileReader(); r.onload = (e) => cb(e.target.result); r.readAsDataURL(file); };

        // STORY Y√úKLEME & Lƒ∞STELEME
        document.getElementById('upStory').onchange = (e) => {
            const f = e.target.files[0]; if(!f) return;
            readFile(f, (res) => push(ref(db, 'anliklar'), { m: res, type: f.type.startsWith('video')?'video':'img', s: myPub, t: Date.now() }));
        };

        function loadStory() {
            onValue(ref(db, 'anliklar'), snap => {
                const cont = document.getElementById('storyCont'); cont.innerHTML = "";
                if(snap.exists()) {
                    Object.entries(snap.val()).reverse().forEach(([k, s]) => {
                        const card = document.createElement('div'); card.className = "anlik-card";
                        card.innerHTML = (s.type === 'video' ? `<video src="${s.m}" autoplay loop muted playsinline class="h-full w-full object-cover"></video>` : `<img src="${s.m}" class="h-full w-full object-cover">`) + 
                        `<div class="absolute bottom-10 left-6 right-6 flex justify-between items-end">
                            <span class="bg-black/50 backdrop-blur-lg px-4 py-2 rounded-full text-[10px] font-black border border-white/10">USER: ${s.s}</span>
                            ${isAdmin ? `<button onclick="killElement('anliklar/${k}')" class="bg-red-600 px-6 py-2 rounded-full text-[10px] font-black uppercase shadow-xl">YOK ET</button>` : ''}
                        </div>`;
                        cont.appendChild(card);
                    });
                } else {
                    cont.innerHTML = `<div class="h-full flex items-center justify-center opacity-20 text-[10px] font-black uppercase tracking-widest">Hen√ºz bir anlƒ±k yok</div>`;
                }
            });
        }

        // POST Y√úKLEME & Lƒ∞STELEME
        document.getElementById('shareBtn').onclick = () => {
            const txt = document.getElementById('postTxt'); const f = document.getElementById('upPost').files[0];
            if(f) {
                readFile(f, (res) => { push(ref(db, 'posts'), { t: txt.value, m: res, type: f.type.startsWith('video')?'video':'img', s: myPub, time: Date.now() }); txt.value=""; document.getElementById('upPost').value=""; });
            } else if(txt.value.trim()) {
                push(ref(db, 'posts'), { t: txt.value, type: 'text', s: myPub, time: Date.now() }); txt.value="";
            }
        };

        function loadPost() {
            onValue(ref(db, 'posts'), snap => {
                const cont = document.getElementById('postCont'); cont.innerHTML = "";
                if(snap.exists()) {
                    Object.entries(snap.val()).reverse().forEach(([k, p]) => {
                        const media = p.m ? (p.type==='video' ? `<video src="${p.m}" controls class="w-full rounded-2xl mb-3 shadow-lg"></video>` : `<img src="${p.m}" class="w-full rounded-2xl mb-3 shadow-lg">`) : '';
                        cont.innerHTML += `<div class="post-card">
                            ${media}<div class="flex justify-between items-start mb-2">
                            <p class="text-[9px] font-black opacity-30 uppercase">Sender ID: ${p.s}</p>
                            ${isAdmin ? `<button onclick="killElement('posts/${k}')" class="text-red-500 text-[10px] font-black hover:underline uppercase">Sƒ∞L</button>` : ''}
                            </div><p class="text-sm font-medium leading-relaxed">${p.t || ''}</p>
                        </div>`;
                    });
                }
            });
        }

        // TEMA & ADMƒ∞N Sƒ∞STEMƒ∞
        window.setTheme = (m) => { document.body.className = m + '-mode'; localStorage.setItem('theme', m); };
        if(localStorage.getItem('theme')) setTheme(localStorage.getItem('theme'));

        let c = 0; document.getElementById('brandTrigger').onclick = () => { c++; if(c>=7) { document.getElementById('secretGuard').style.display='flex'; c=0; } };
        document.getElementById('authBtn').onclick = () => {
            const m = atob("Q2loYW5fQkFMQ0lf") + atob("TWFza0NoYXRfMjAyNl8=") + atob("U2VjdXJlX1g3");
            if(document.getElementById('guardKey').value === m) { localStorage.setItem('maskAdmin', 'true'); location.reload(); }
        };
        if(isAdmin) { 
            const aBtn = document.getElementById('adminBtn'); aBtn.innerText="ADMƒ∞N MODU: AKTƒ∞F"; aBtn.style.opacity="1"; aBtn.classList.add('text-indigo-500','border-indigo-500/20','bg-indigo-500/5');
        }
    </script>
</body>
</html>